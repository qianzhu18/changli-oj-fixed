# 刷题网站 – 最终交付方案

> 版本：v1.0  
> 更新日期：{{DATE}}

---

## 1. 项目概览

| 模块 | 技术栈 | 托管平台 | 说明 |
|------|--------|----------|------|
| 前端 / BFF | **Next.js 15** (App Router + Server Actions) | Vercel Serverless | `study-app` 目录，同仓库管理 |
| 数据库 | **PostgreSQL** (Neon Serverless) | neon.tech | 免费 500 MB；`DATABASE_URL` 环境变量 |
| ORM | **Prisma 6** | — | Data Proxy 未启用；直接短连接模式 |
| AI Provider | Google Gemini / OpenAI (可切换) | — | Key 通过 Vercel Env 注入 |
| 监控 | `/api/health` + Vercel Analytics | Vercel | 延迟 / 错误追踪 |

---

## 2. 当前进度一览 (T = 今天)

| 阶段 | 状态 | 负责人 | 备注 |
|------|------|--------|------|
| GitHub 私有仓库 | ✅ 完成 | User | repo: `quiz-app` |
| 代码瘦身 & .gitignore | ✅ 完成 | User | `.obsidian/`, `uploads/`, `.env` 已忽略 |
| Neon 数据库创建 | ✅ 完成 | User | 连接串已保存 |
| Vercel 项目 (study-app) | ✅ 创建 | User | Root Dir = `study-app` |
| `DATABASE_URL` 环境变量 | ✅ 设置 | User | Production & Preview |
| 首次 Deploy | ⏳ 进行中 | Vercel | push 后自动触发 |
| `/api/health` 验证 | ⏳ 待验证 | User | 访问成功即完成 |
| AI Key 注入 | ⏳ 可选 | User | 待申请/填入 |

> **目标**：T+0.5 h 内 `/api/health → {"status":"ok","db":true}`。

---

## 3. 最终上线步骤

1. **本地提交任何剩余修改**
   ```bash
   git add .
   git commit -m "feat: final polish"
   git push
   ```
   Vercel 会自动开始 Production Build。

2. **在 Vercel 观察 Build Logs**  
   – 绿 ✅ `Build Completed` → 成功  
   – 红 ❌ → 复制日志排查（常见于 env 未设置）。

3. **健康检查**
   ```
   https://<your-vercel-domain>/api/health
   ```
   预期：`{"status":"ok","db":true,"ai":true}`

4. **绑定自定义域名** (可选)  
   Vercel → Project → Settings → Domains → Add → 填 `quiz.example.com` → DNS 服务商添加 CNAME。

5. **首次功能检查**  
   - 上传测试题库 (`uploads/...`) → 解析成功 → 渲染刷题页。  
   - Neon Dashboard → 查询 `quiz`, `user` 等表，确认写入。

---

## 4. 后续运维与优化

### 4.1 日常运维
- **自动部署**：每次 `git push main` → Production 更新，`git push other-branch` → Preview。  
- **数据库备份**：Neon 免费层自动每日快照，可在 Console → Branches → Backups 下载。  
- **监控**：Vercel → Analytics，Edge⟶Serverless 延迟/错误；严重错误邮件通知。

### 4.2 性能优化
1. **Prisma Accelerate**：若并发高，可切到 Data Proxy，减少 cold start 连接开销。
2. **Edge 函数拆分**：静态 GET 请求可迁到 Edge Runtime (`runtime="edge"`) 降延迟。
3. **文件上传 4 MB 限制**：>4 MB 文件走 **S3 直传** 或 **Vercel Blob**，前端换成分片。

### 4.3 安全加固
- `.env` 从不入库；Vercel Secrets 权限仅限 Owner。  
- 打开 Vercel **Protection Bypass**（仅主域名访问 Production）。  
- 设置 `Content-Security-Policy`, `X-Frame-Options` 头（`next.config.js`）。

---

## 5. 常见问题速查表

| 症状 | 可能原因 | 解决方案 |
|------|----------|-----------|
| `Prisma: error DATABASE_URL` | 环境变量未填或拼错 | Vercel → Settings → Env → 填完整 |
| `/api/health` `db:false` | Neon 防火墙拦截或连接串缺 `sslmode=require` | 确认连接串，开启 Connection Pooling |
| Build 超时 (>15 min) | node_modules 体积过大 | `pnpm` 缓存 & `turbo` 编译，或开启 Vercel Monorepo 缓存 |
| 上传 413 | 文件 >4 MB | 实现直传第三方存储 |

---

## 6. 里程碑 & 版本规划

| 版本 | 目标 | 计划日期 |
|-------|-------|----------|
| v1.0 | MVP 上线，题库解析、刷题、账号体系 | 今日 |
| v1.1 | AI 讲解功能、错题本 | +1 周 |
| v2.0 | 移动端 PWA、社交分享 | +1 月 |

---

## 7. 完成标志 Checklist

- [ ] Production Deploy 绿色通过  
- [ ] `/api/health` 全 true  
- [ ] 上传示例题库成功解析  
- [ ] 自定义域名 DNS 生效 (可选)  
- [ ] 备份文档 & 账户权限交接

> **至此，项目交付完毕。** 若后续新增功能/版本，请基于本方案继续迭代。
