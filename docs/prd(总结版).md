# Changli OJ PRD（收敛版）

更新时间：2026-02-28  
文档状态：执行版（用于从“混乱开发”切换到“可交付开发”）

---

## 1. 项目结论（先定边界）

当前项目的唯一目标是：

1. 管理员发布题库、发布题目。
2. 用户刷题、记录进度、查看错题。
3. 后续再加 AI 陪伴和对话服务。

明确不在本项目内做：

1. OCR 识别与题库转换流程（由外部自动化工作流负责）。
2. 复杂多组织/多租户后台。
3. 大而全的运营系统（支付、营销、增长中台等）。

---

## 2. 核心目标 (Mission)

做一个稳定、可持续运营的“题库发布 + 刷题系统”，先把主链路跑通，再逐步增加 AI 能力。

衡量标准（V1）：

1. 管理员可完成“上传（纯文本）- 解析 - 编辑 - 发布”全流程。
2. 用户可完成“注册/登录 - 刷题 - 进度续学 - 错题复习”全流程。
3. 核心流程可通过本地回归（API + 页面）并可重复验证。

---

## 3. 用户画像 (Persona)

### 3.1 普通用户（考生）

- 目标：高效刷题、复盘错题、持续学习。
- 关键路径：登录 -> 进入题库 -> 刷题 -> 查看错题与进度。

### 3.2 开发者/运营人员（developer）

- 目标：管理题库内容，保证题目可用和可发布。
- 关键路径：管理面板 -> 上传题库 -> 解析结果校验 -> 编辑 -> 发布。

### 3.3 系统管理员（root）

- 目标：配置权限、兜底处理异常、保证系统运行。
- 关键路径：角色管理（环境配置）-> 管理接口巡检 -> 异常处理。

---

## 4. V1: 最小可行产品 (MVP)

### 4.1 账号体系（Supabase Auth）

1. 注册：邮箱 + 密码（不需要邮箱验证码）。
2. 登录：邮箱 + 密码。
3. 忘记密码：邮件重置链接。
4. 角色：`user` / `developer` / `root`（通过环境变量邮箱映射）。

### 4.2 题库管理（管理端）

1. 上传文本题库（`.txt` / `.md`）。
2. 创建题库记录并触发解析任务。
3. 解析完成后可编辑题目内容。
4. 发布/下架题库。

### 4.3 刷题主流程（前台）

1. 浏览已发布题库。
2. 进入题库按题作答。
3. 自动记录进度（可继续学习）。
4. 自动记录错题并可查看错题本。

### 4.4 最低质量保障

1. 本地固定端口 `3001` 可运行。
2. 核心接口具备基础烟测。
3. 关键页面（登录/注册/忘记密码）可通过脚本回归。

---

## 5. V2 及以后版本 (Future Releases)

### V2（优先）

1. AI 陪伴/追问（基于当前题目上下文）。
2. 解析质量增强（题型识别、格式容错、异常提示）。
3. 管理面板统计增强（题库质量、使用热度、报错闭环）。

### V3（可选）

1. 与 OCR 自动化流程打通（外部系统推送标准化题库）。
2. 更细粒度权限与审计日志。
3. 推荐系统（学习路径、薄弱点推荐）。

---

## 6. 关键业务逻辑 (Business Rules)

1. 未发布题库不得在前台展示。
2. 管理接口仅 `developer/root` 可访问。
3. `user` 只能访问个人学习数据（进度/错题）。
4. 上传只接收文本文件，解析任务异步执行。
5. 解析失败题库应可重试解析。
6. 忘记密码必须依赖可用 SMTP，若未配置应有明确错误提示。

---

## 7. 数据契约 (Data Contract)

### 7.1 核心实体

1. `users`：用户资料（id/email/name/is_active）。
2. `quizzes`：题库（title/status/is_published/raw_text/html/question_count）。
3. `questions`：题目（quiz_id/index/type/question/options/answer/explanation）。
4. `progress`：进度（user_id/quiz_id/current_index/completed_count）。
5. `wrong_questions`：错题记录（user_id/quiz_id/question_index/user_answer）。
6. `jobs`：解析任务（quiz_id/type/status/progress/data）。

### 7.2 数据流向

1. 管理端上传 -> `quizzes` 创建 -> `jobs` 入队 -> worker 解析 -> `questions` 写入。
2. 前台作答 -> `progress` 更新 -> 错误答案写入 `wrong_questions`。
3. 发布动作 -> `quizzes.is_published=true`，前台可见。

---

## 8. 页面与模块范围（V1）

### 8.1 前台

1. `/login`
2. `/register`
3. `/forgot-password`
4. `/reset-password`
5. `/square`（题库广场）
6. `/quiz/[id]`（刷题）
7. `/wrong-questions`

### 8.2 管理端

1. `/admin`
2. `/admin/quizzes`
3. `/admin/quizzes/[id]`
4. `/admin/reports`
5. `/admin/stats`

---

## 9. 需求台账（MVP）

| 功能 | 用户故事 | 验收标准 | 影响模块 |
|---|---|---|---|
| 注册/登录 | 作为用户，我要能注册登录以保存进度 | 无验证码完成注册登录；失败有明确错误文案 | `app/login` `app/register` `app/api/auth/*` |
| 忘记密码 | 作为用户，我忘记密码时能通过邮件找回 | 提交邮箱后收到重置邮件；可设置新密码并登录 | `app/forgot-password` `app/reset-password` `app/api/auth/forgot-password` |
| 角色权限 | 作为系统，我要限制管理接口访问 | user 访问管理接口返回 403；developer/root 返回 200 | `lib/auth.ts` `lib/admin.ts` `app/api/admin/*` |
| 上传与解析 | 作为运营，我要上传题库并完成解析 | 上传成功返回 quizId；状态可从 pending 到 completed | `app/api/admin/upload` `worker/parse-worker.cjs` |
| 题库发布 | 作为运营，我要控制题库上下架 | 已发布题库在前台可见，未发布不可见 | `app/api/admin/quizzes/*` `app/api/quizzes` |
| 刷题与进度 | 作为用户，我要持续刷题并保存进度 | 作答后更新进度；可继续学习 | `app/quiz/[id]` `app/api/progress` |
| 错题本 | 作为用户，我要复习错题 | 错题可记录、可读取、可移除 | `app/wrong-questions` `app/api/wrong-questions/*` |

---

## 10. 开发节奏（建议）

### 阶段 A：先把主链路跑通（1 周）

1. 锁定认证与角色权限。
2. 跑通上传 -> 解析 -> 发布 -> 刷题。
3. 完成忘记密码 SMTP 配置与回归。

### 阶段 B：提稳定性（1 周）

1. 核心接口错误码标准化。
2. 解析失败重试和日志可见性。
3. 增加关键流程自动化测试。

### 阶段 C：再引入 AI（后续）

1. 先做“题目追问”而不是全量 AI 化。
2. 通过 feature flag 控制上线风险。

---

## 11. 当前已知风险与对策

1. 风险：需求频繁扩张导致开发失焦。  
   对策：任何新需求先归类为 V2/V3，不进入 V1。
2. 风险：邮件服务未配置导致忘记密码不可用。  
   对策：按《忘记密码邮箱配置》完成 SMTP 与限流。
3. 风险：上传解析链路依赖 worker，易被忽略启动。  
   对策：开发环境固定“双进程”：`web + worker`。
4. 风险：多角色逻辑变更后未回归。  
   对策：保留 user/developer/root 三账号烟测脚本。

---

## 12. 待办清单（你现在就做这几件）

- [ ] 按 [忘记密码邮箱配置.md](./忘记密码邮箱配置.md) 完成 SMTP 配置。  
- [ ] 固定 V1 范围，不再新增无关需求。  
- [ ] 每次迭代必须过 7 条验收：注册、登录、找回、上传、发布、刷题、错题。  
- [ ] AI 功能全部放到 V2，V1 不再穿插开发。  

---

## 13. 一句话执行原则

先把“发布题库 + 刷题”做成稳定产品，再做“自动化转换 + AI 陪伴”。  
任何偏离这条主线的需求，默认延期到 V2/V3。
