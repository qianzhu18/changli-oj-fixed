# 注册登录与忘记密码：邮件服务配置待办清单

这份文档是给你“照着点就能完成”的版本，不需要先懂 SMTP 原理。

## 0. 先说结论

- 是的，忘记密码邮件必须去邮件服务商配置（例如 Resend / Postmark / AWS SES）。
- 原因：Supabase 默认邮件通道限制非常严格，只适合开发测试，不适合正式业务。
- 你当前项目已经改为：
  - 注册：邮箱 + 密码（不需要邮箱验证码）
  - 登录：邮箱 + 密码
  - 找回密码：通过 Supabase 发送重置邮件链接

---

## 1. 全流程图（你要完成的业务流程）

1. 用户注册（`/register`）  
2. 用户登录（`/login`）  
3. 忘记密码（`/forgot-password`）提交邮箱  
4. Supabase 调用 SMTP 服务发邮件  
5. 用户点击邮件中的重置链接，进入 `/reset-password`  
6. 提交新密码，完成重置并重新登录

---

## 2. 待办事项（按顺序执行）

> 你可以把这一段当项目 TODO，后续逐项勾选。

- [ ] 在本地配置角色邮箱（`.env.local`）
- [ ] 在 Supabase 配置 URL（Site URL + Redirect URLs）
- [ ] 选一个邮件服务商并完成账号开通
- [ ] 在邮件服务商完成发信域名验证（SPF/DKIM，建议 DMARC）
- [ ] 把 SMTP 参数填入 Supabase 的 SMTP 设置
- [ ] 调整 Supabase Auth 邮件限流
- [ ] 本地回归测试注册/登录/忘记密码

---

## 3. 第一步：本地 `.env.local` 配置（你本机做）

在项目根目录 `.env.local` 增加/修改：

```bash
ROOT_EMAILS=root1@yourdomain.com
DEVELOPER_EMAILS=dev1@yourdomain.com,dev2@yourdomain.com
ADMIN_EMAILS=
APP_ORIGIN=http://localhost:3001
```

说明：

- `ROOT_EMAILS`：root 权限邮箱（最高权限）
- `DEVELOPER_EMAILS`：开发者权限邮箱（可进管理面板）
- `ADMIN_EMAILS`：旧兼容字段，可留空
- `APP_ORIGIN`：忘记密码邮件回跳地址，当前本地调试用 `3001`

---

## 4. 第二步：Supabase 控制台要点（你去 Supabase 做）

登录 Supabase 项目后：

### 4.1 URL 配置（必须）

路径：`Authentication -> URL Configuration`

建议填写：

- `Site URL`: `http://localhost:3001`（本地开发）
- `Redirect URLs`: `http://localhost:3001/**`

如果有线上域名，再额外加入：

- `https://your-domain.com/**`

### 4.2 SMTP 配置（必须）

路径（界面命名可能略有变化）：

- `Authentication -> SMTP Settings`
- 或 `Authentication -> Notifications -> Email -> SMTP`

操作：

1. 打开 `Enable Custom SMTP`
2. 填入服务商提供的参数：
   - Sender email
   - Sender name
   - Host
   - Port
   - Username
   - Password
3. 保存

### 4.3 Rate Limits（建议）

路径：`Authentication -> Rate Limits`

重点关注邮件发送相关限流（`rate_limit_email_sent`），否则会继续出现 `429 over_email_send_rate_limit`。

Supabase 官方参考：

- SMTP 配置：https://supabase.com/docs/guides/auth/auth-smtp
- Rate Limits：https://supabase.com/docs/guides/auth/rate-limits
- Redirect URLs：https://supabase.com/docs/guides/auth/redirect-urls

---

## 5. 邮件服务商推荐（先选一个）

> 下面是“从哪里开始找”的清单，按上手难度排序。

### 方案 A（推荐先用）：Resend

- 适合：想最快跑通
- 上手：简单
- 官方入口：
  - 网站：https://resend.com
  - SMTP 文档：https://resend.com/docs/send-with-smtp
  - 定价：https://resend.com/pricing

### 方案 B（稳定性强）：Postmark

- 适合：重视事务邮件送达率和监控
- 上手：中等
- 官方入口：
  - 网站：https://postmarkapp.com
  - SMTP 文档：https://postmarkapp.com/developer/user-guide/send-email-with-smtp
  - Supabase 集成示例：https://postmarkapp.com/support/article/integrating-postmark-with-supabase-via-smtp
  - 定价：https://postmarkapp.com/pricing

### 方案 C（量大成本低）：AWS SES

- 适合：发送量较大，能接受 AWS 配置复杂度
- 上手：偏难
- 官方入口：
  - SES SMTP 凭证：https://docs.aws.amazon.com/ses/latest/dg/smtp-credentials.html
  - SMTP 发送说明：https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html

### 方案 D（可选）：Brevo

- 适合：需要欧系服务备选
- 上手：中等
- 官方入口：
  - SMTP relay 文档：https://developers.brevo.com/docs/smtp-integration

---

## 6. 推荐执行策略（最省时间）

1. 先用 `Resend` 跑通本地（30 分钟内可完成）  
2. 测试通过后，再评估是否切换 `Postmark` / `AWS SES`  
3. 上线前一定完成域名验证（SPF/DKIM/DMARC）和限流调整  

---

## 7. 验收清单（完成即表示链路打通）

- [ ] `/register` 能正常注册
- [ ] `/login` 能正常登录
- [ ] `/forgot-password` 提交后能收到邮件
- [ ] 点击邮件链接能进入 `/reset-password`
- [ ] 提交新密码后可用新密码登录
- [ ] 普通用户访问 `/api/admin/stats` 返回 403
- [ ] developer/root 访问 `/api/admin/stats` 返回 200

---

## 8. 备注

- 这份文档是“待办版操作说明”，你现在不需要一次做完。  
- 建议先完成第 3、4、5 章，再做第 7 章验收。  
