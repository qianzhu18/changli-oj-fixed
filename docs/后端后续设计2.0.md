# 刷题网站项目分析评估与后端后续开发设计（2.0）

> 版本：2025-07-24  
> 作者：项目后端负责人  
> 目标读者：全体研发、PO、DevOps、测试同学

---

## 1. 项目背景与最终目标
刷题网站旨在为学生及职场人士提供多学科题库、智能解析、刷题练习与数据分析功能，提升学习效率。

* **终极目标**：后端服务可通过 **Docker** 一键构建并部署到服务器，在生产环境稳定支撑 10K+ 并发用户。
* **关键约束**：
  1. 安全合规（GDPR/网安法）
  2. AI 成本可控 & 故障降级
  3. 迭代速度快、可维护性强

---

## 2. 当前状态综合评估

| 维度 | 现状 | 得分 (满分10) | 说明 |
| ---- | ---- | ------------ | ---- |
| 功能完成度 | 核心刷题功能、AI 解析、练习/测验已具备 | 6 | 缺收藏夹、错题本等进阶功能 |
| 技术架构 | Node.js+Express+Prisma 单体架构 | 7 | 模块清晰，但扩展/监控不足 |
| 性能与稳定性 | Dev 水平压测 QPS≈400 | 5 | 无缓存、无水平扩展策略 |
| 安全与合规 | 基础 JWT、密码哈希 | 4 | 未引入速率限制 & CSRF 保护 |
| DevOps & CI/CD | Dockerfile & compose(dev) | 3 | 无自动化镜像推送 / 部署 |
| 测试覆盖率 | <20% | 2 | E2E 未引入、集成测试缺失 |
| 文档完整度 | 设计/API 文档零散 | 3 | 缺统一 docs 目录 & 生成流程 |

> **总评分：30/70**（≈43%），与生产上线要求仍有显著差距。

---

## 3. 核心痛点与风险
1. **AI 成本 & 速率限制**：高并发调用带来费用及限流风险。
2. **队列可靠性**：Worker 无重试告警，任务失败易遗漏。
3. **数据一致性**：异步评分与实时统计间可能出现延迟。
4. **DevOps 空缺**：缺少自动化流程及监控告警。
5. **合规要求**：日志脱敏、数据加密策略尚未落地。

---

## 4. 设计原则（融合 Augment 开发 Tips）
1. **清晰需求 = 有效 AI**：Issue/PR 模板必须包含背景→目标→验收标准。
2. **及时纠偏**：方向错误立即停止、开新分支或窗口实验；使用 Git checkpoint 小步提交。
3. **记忆管理**：重要规则写入 `docs/architecture.md` & 代码注释，借助 Augment 记忆保证一致性。
4. **编号分段**：多项需求强制 `1. 2. 3.` 排列，便于讨论与 AI 理解。
5. **Playwright MCP**：引入自动化 E2E 测试，调试日志复制供 AI 快速定位问题。

---

## 5. 后端 2.0 技术架构设计

````mermaid
graph TD
  Browser -->|REST/WS| Nginx/Traefik
  Nginx/Traefik --> app(App Server)
  app -->|Prisma| db[(PostgreSQL)]
  app --> queue(Redis/Sidekiq)
  queue --> worker(Worker)
  worker -->|Prisma| db
  app --> cache((Redis Cache))
  Loki(Grafana Loki) -.-> log[Logs]
  Prometheus --> metrics[(Metrics)]
  Nginx/Traefik --> certbot(Certbot)
````

### 5.1 核心模块
1. **API Gateway (Nginx/Traefik)**：SSL 终止、路由、速率限制。
2. **应用层 (Express)**：REST + WebSocket，采用 **模块化路由** (`routes/v2/*`)。
3. **数据库 (PostgreSQL)**：采用高可用 RDS，Prisma 作为 ORM。
4. **缓存 (Redis)**：AI 解析结果、Session、热点题库缓存。
5. **队列 (BullMQ/Sidekiq)**：解析任务、测验评分异步处理。
6. **监控 (Prometheus & Grafana + Loki)**：指标、日志、告警统一。

### 5.2 关键技术决策
* **代码结构**：`src/` 采用领域驱动 (domain-driven) 子目录；Controller- Service- Repository 分层。
* **错误处理**：核心 `ApiError` 统一封装，映射 HTTP 状态码与错误码。
* **安全**：Helmet、CSRF Token、RateLimiter、Bcrypt+Pepper。
* **国际化**：后端错误信息 & 邮件模板 i18n。
* **OpenTelemetry**：Tracing + APM 接入。

---

## 6. Docker 化与部署策略

| 阶段 | 任务 | 输出 | 工时 | Owner |
| ---- | ---- | ---- | ---- | ---- |
| 1 | 多阶段 Dockerfile 优化 | `docker/Dockerfile` | 1d | BE |
| 2 | 健康检查 & 非 root 运行 | HEALTHCHECK, UID=1001 | 0.5d | BE |
| 3 | 环境 & Secrets 管理 | `.env.example`, Docker secrets | 0.5d | DevOps |
| 4 | 日志 Driver 设置 | json-file → loki | 0.5d | DevOps |
| 5 | GitHub Actions Workflow | `ci.yml` 构建→测试→推镜像 | 1d | DevOps |
| 6 | 服务器部署脚本 | `deploy/docker-compose.yml` | 0.5d | DevOps |
| 7 | 反向代理 & HTTPS | Traefik 配置, LetsEncrypt | 0.5d | DevOps |

> **预计总工时：4-5 人日** 可以完成基本生产部署。

---

## 7. 详细功能路线图（12 周）

| Sprint | 主题 | 关键交付物 |
| ------ | ---- | ---------- |
| S1 (Week 1-2) | 基础设施 | Dockerfile 优化、CI、HEALTHCHECK、Prometheus 集成 |
| S2 (Week 3-4) | 高级功能 | 收藏夹、错题本、题库标签、版本管理 |
| S3 (Week 5-6) | AI & 队列 | AI 缓存策略、BullMQ 重试 & Dashboard、成本监控 |
| S4 (Week 7-8) | 安全强化 | RateLimiter、CSRF、日志脱敏、合规审计 |
| S5 (Week 9-10) | 性能优化 | Redis 缓存、SQL 索引、压力测试 & 调优 |
| S6 (Week 11-12) | 上线准备 | E2E 测试 90% 覆盖、灾备脚本、蓝绿发布 |

---

## 8. 测试策略
1. **单元测试 (Jest)**：目标覆盖率 80%，Service & Util 层必测。
2. **集成测试 (Supertest)**：核心 API 路由、数据库交互。
3. **E2E 测试 (Playwright MCP)**：用户核心路径 + 题库上传解析。
4. **性能测试 (k6)**：并发压测 ≥1K RPS，P95 <300ms。

---

## 9. 文档与沟通
1. **docs/** 目录结构：
   * `architecture.md` 架构概览（Mermaid 图）
   * `api-spec.yaml` OpenAPI 3.1
   * `docker/README.md` Docker 化指南
   * `ci-cd.md` Workflow 说明
   * `monitoring.md` 监控与告警
2. **CI 校验**：MarkdownLint + Spellcheck；新文档 PR 必须通过检查。
3. **周会**：每周五 Demo + Retro + Next sprint 计划。

---

## 10. 资源与预算评估
* **服务器**：2C/4G (dev) + 4C/8G (prod)；预留 Redis、PostgreSQL。
* **AI Token**：预计月度 50 USD（可调整模型 & 缓存策略优化）。
* **监控栈**：Grafana Cloud Free / 自建 Loki+Promtail (~10 USD/月)。

---

## 11. 结论与下一步
1. 当前后端完成度 ~45%，主要差距集中在 **DevOps、监控、测试**。
2. 按照本设计方案执行，可在 **12 周** 内达到生产发布标准。
3. 建议即刻创建 **Phase1** 任务 & 对应 Issues，启动 Sprint 1。

> **行动项**：2025-07-25 召开 Kickoff，同步 OKR 与资源排期。
