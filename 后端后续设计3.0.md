# 刷题网站后端评估报告与改进设计（3.0）

> 日期：2025-07-24  
> 作者：后端技术负责人  
> 适用读者：所有研发成员，尤其是“Claude”同学

---

## 1. 评估概览

| 维度 | 2.0 目标状态 | 实际现状 | 差距 | 优先级 |
| ---- | ------------ | -------- | ---- | ---- |
| Gemini API 验证 | 新用户仅需填 Key 即可正常调用 | **无法通过验证，API 调用失败** | 👎 功能不可用 | P0 |
| 核心功能完整度 | 练习 / 测验 / AI 解析全流程可跑通 | 部分流程因 AI 失败被阻断 | 🚫 影响主链路 | P0 |
| 产品演示 | Demo 脚本 + 数据可一键演示 | 演示需手动 Mock | P1 |
| 生产部署 | Docker 化、CI/CD、监控可用 | CI/CD 未接 API 验证，镜像缺健康检查 | P1 |
| Git 存档 | 分支规范、Tag Release | Commit 零散，Tag 缺失 | P2 |

> **结论：** Gemini 集成失效导致“✅”判定失真；需立刻修复并补充演示数据与自动化检测。

---

## 2. Gemini 集成问题排查

### 2.1 现有实现
* 关键文件：`backend/src/services/gemini.ts`, `aiService.ts`, `config/settings.ts`。
* 依赖：`@google/generative-ai` NPM 包。
* 验证逻辑：`GET /api/ai/validate-key` → `aiController.validateGeminiKey()`

### 2.2 常见失败原因
| 编号 | 描述 | 代码位置 | 修复建议 |
| ---- | ---- | -------- | -------- |
| E1 | 未读取 `.env` 中 `GEMINI_API_KEY` | `gemini.ts` L11 | 使用 `dotenv` 或 `config.ts` 统一加载 |
| E2 | Key 无效 / 权限不足 | `utils/configValidator.ts` L202 | 捕获 401, 返回明确错误信息 |
| E3 | Free Tier 限流 | Service 层无重试 | 增加指数退避 & 缓存 |
| E4 | 网络超时 | Axios 默认超时过低 | 设置 30s timeout & Retry |

---

## 3. 功能精细化修改计划

### 3.1 Gemini 服务抽象
1. 创建接口 `IAiProvider`：`validateKey()`, `generateQuizHtml()` …
2. 实现 `GeminiProvider` & `OpenAIProvider`，切换由 `AI_PROVIDER` 环境变量控制。
3. 单元测试：Mock HTTP + Invalid Key 场景。

### 3.2 验证端点增强
* `GET /api/ai/validate-key`：返回 JSON
  ```json
  {"valid":false,"reason":"API key invalid or quota exceeded"}
  ```
* 前端对接：`/study-app/api/validate-key` 提前检测，UI 反馈。

### 3.3 缓存 & 降级
* Redis 缓存最近一次验证结果 1h。
* 如果验证失败 → 切换 `provider=mock` 返回占位解析。

---

## 4. Git 管理与存档指南
1. **分支策略**
   * `main`：始终可部署
   * `dev`：日常合并，CI 运行
   * `feat/*`，`fix/*`：主题分支
2. **Commit 规范**：Conventional Commits
3. **Tag / Release**
   * 每次可部署版本打 `vX.Y.Z`
   * Tag 后触发 GitHub Actions: 打包镜像 → 发布 Release Note。
4. **Git Hooks**：`husky` + `lint-staged` 确保提交代码通过 ESLint & Prettier。

---

## 5. 操作指南（指挥 Claude）

```bash
# 0. 同步主干
git checkout dev && git pull origin dev

# 1. 新建修复分支
git checkout -b fix/gemini-validation

# 2. 安装依赖 & 运行测试
pnpm install
pnpm test --filter backend

# 3. 修改代码
#   - services/aiService.ts
#   - services/gemini.ts
#   - utils/configValidator.ts

# 4. 本地验证
export GEMINI_API_KEY="YOUR_KEY"
pnpm --filter backend dev
# 调用 localhost:3000/api/ai/validate-key

# 5. 写单元测试
pnpm --filter backend jest services/__tests__/gemini.spec.ts

# 6. 提交 & 推送
git add .
git commit -m "fix(ai): improve gemini key validation and error handling"
git push origin fix/gemini-validation

# 7. 创建 PR
# 标题: fix(ai): Gemini key validation fails when key invalid
# 描述: 详述原因、解决方案、测试结果。
```

---

## 6. 新 CI/CD 检查项
* **Step: Validate Gemini Key**
  * 使用项目测试 Key 调用 `/api/ai/validate-key`；失败则 CI 终止。
* **Step: E2E Demo Flow**
  * Playwright 执行：登录 → 设置 Key → 上传题库 → 解析成功。

---

## 7. 里程碑与时间表（1 周冲刺）
| Day | 任务 | 责任人 |
| --- | ---- | ------ |
| D1 | 创建接口抽象 & 重构 Provider | Claude |
| D2 | 实现验证端点增强 & 单测 | Claude |
| D3 | 实现缓存 & 降级策略 | Claude |
| D4 | 前端交互改造 & Playwright 脚本 | 前端 ｜
| D5 | CI/CD 更新 & Docker 健康检查 | DevOps |
| D6 | 全链路演示 & Bug 修复 | 全体 |
| D7 | 打 Tag `v0.9.0-beta`，发布测试版 | PM |

---

## 8. 验收标准
1. **Gemini 关键路径通过率 ≥ 95%**（连续 100 次调用）
2. **CI 通过**：单位测试覆盖≥80%，E2E 流程 100% 成功。
3. **Docker Compose 部署成功**：`docker compose up -d` 后 `/healthz` 为 200 OK。

---

## 9. 补充文档
* `docs/ai-provider.md`：Provider 接口说明 + 接入指引
* `docs/demo-script.md`：一键演示脚本，涵盖数据准备 & 操作步骤

> 请 Claude 按照 **操作指南** 执行修复，任何阻塞请在 Issue 反馈。
