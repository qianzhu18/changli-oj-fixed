# 后端后续设计 4.0

> 更新时间：2025-07-25

## 1. 项目现状总览

| 模块 | 技术栈 | 当前进度 | 备注 |
| ---- | ------- | -------- | ---- |
| **前端 (study-app)** | Next.js 15 + TypeScript + TailwindCSS | 🎯 **80%**（核心功能已可用，UI 基本完成） | *仅保留此版本，其余 old/mixed-backup 作为历史回顾* |
| **后端 (backend)** | Node 18 + Express + Prisma + BullMQ | 🏗 **70%**（v2 路由与服务框架成型） | v1 将冻结，只做安全补丁 |
| **AI / 解析服务** | Google Gemini API + 自研 Parser | ⚙️ **60%**（解析流程可用，缺乏错误兜底与监控） | 多格式支持已就绪 |
| **DevOps / 部署** | Docker + Docker-Compose | 🐳 **50%**（本地容器化可跑通） | 未接入 CI/CD、生产安全加固 |
| **测试** | Jest + Supertest / Playwright | ✅ **20%**（样例测试存在） | 覆盖率低，缺持续集成 |
| **文档** | Markdown | 📚 **40%**（快速上手友好） | 架构/ADR/Swagger 不完整 |

---

## 2. 关键问题与风险

1. **代码分叉**：历史 UI 目录仍占用空间；v1/v2 API 并存导致维护成本升高。
2. **测试缺口**：单元 + E2E 覆盖不足，CI 未上线，回归成本高。
3. **安全合规**：JWT 密钥、Gemini Key 仅存 .env；接口缺速率限制、Helmet。
4. **可观测性不足**：缺统一日志、性能指标、异常告警，问题排查困难。
5. **部署流水线**：目前仅本地 Docker，未配置自动构建、推送与版本回滚。

---

## 3. 后续行动计划

### 3.1 代码收敛

- 前端仅保留 **study-app** 目录，删除 old / mixed-backup。
- 后端冻结 **v1**，所有新功能在 **v2** 实现并回迁遗留接口。

### 3.2 自动化与质量

1. **CI**：GitHub Actions → lint → type-check → Jest → Build 镜像。
2. **测试**：
   - 单元：覆盖核心服务（auth、parser、aiService）。
   - 集成：Supertest 走完整上传-解析-答题流程。
   - 端到端：Playwright 覆盖登录、题库创建、作答。

### 3.3 安全与监控

- Middleware：Helmet、rate-limit、CORS 白名单。
- 日志：Pino + Loki/Grafana；错误：Sentry。
- Prometheus + Grafana 导出 CPU/内存、队列深度。

### 3.4 部署流水线

```
GitHub Push → Actions 构建 → Docker 镜像推送 GHCR → 
服务器 watchtower 自动拉取 → zero-downtime 重启
```

- 生产数据库改 PostgreSQL，Prisma 迁移脚本自动执行。
- 使用 **dotenv-flow** + GitHub Secrets 管理敏感配置。

### 3.5 文档治理

- 建立 `docs/`：API (OpenAPI)、架构图、ADR、运维手册。
- CHANGELOG 采用 Conventional Commits + auto-changelog。

---

## 4. 整体时间预估

| 任务 | 负责人 | 工时 (人/天) |
| ---- | ------- | ------------ |
| 代码目录清理 & 路由迁移 | BE/FE | 1 |
| GitHub Actions + 镜像构建 | DevOps | 1 |
| 单元+集成测试补全 (60% 覆盖) | QA/BE | 2 |
| 安全中间件 & 环境变量治理 | BE | 1 |
| 日志/监控接入 | DevOps | 1.5 |
| PostgreSQL & 数据迁移脚本 | BE | 1 |
| 文档集中与 ADR 编写 | 全体 | 1 |
| **合计** |  | **8.5 人/天 ≈ 1.5 周** |

> ⚡ **加急模式**：2-3 名开发并行，可在 **5-6 天** 内完成交付并部署到生产服务器。

---

## 5. 里程碑 Roadmap

| 阶段 | 目标 | 截止 | 关键交付物 |
| ---- | ---- | ---- | -------- |
| M1 | 目录收敛 + v2 API 完整 | +3 天 | 单一前端目录 + v1 冻结说明 |
| M2 | CI/CD & 测试 ≥60% 覆盖 | +6 天 | Actions 流水线、覆盖率报告 |
| M3 | 安全 & 监控到位 | +8 天 | Helmet/rate-limit + Sentry + Grafana |
| M4 | 正式部署 & 文档完备 | +10 天 | 生产环境上线 + docs 站点 |

---

### 6. 结语

当前系统已具备核心功能，剩余工作以**收敛代码、提升质量、完善运维**为主。按照上表计划推进，最晚两周内即可打包上线，届时用户可流畅体验“AI 智能题库系统·墨隐侠踪版”。
